<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>修改</title>
    <link rel="stylesheet" href="__PUBLIC__/js/layui/layui/css/layui.css">
    <link rel="stylesheet" href="__TMPL__Public/assets/css/reset.css"/>
    <link rel="stylesheet" href="__TMPL__Public/assets/css/hr_public.css"/>
    <style>
        #turnover input{ text-align: center;}
    </style>
</head>
<body>
<div style="min-width: 1440px; margin: 50px;">
    <div class="clear">
        <div class="fl add-table">
            <div class="msg">
                <div class="msg-error" id="msgError"></div>
            </div>
            <form action="/index.php?g=api&m=TgEmployees&a=add" method="post" enctype="multipart/form-data" class="layui-form" id="addForm">

            </form>
        </div>
    </div>

    <div style="margin: 50px 0;">
        <dl class="evaluation-list" id="evaluationList">
            <dt>人事评价</dt>
            <!--<dd>2018-07-23</dd>-->
            <!--<dd>2018-07-24</dd>-->
        </dl>
    </div>
    <!--<div style="margin-right: 10px;" id="addForm"></div>-->
    <div id="charts">
        <div class="chart-view" id="moneyStaticBox">
            <div class="tab">
                <div class="tab-chart day">天</div>
                <div class="tab-chart week">周</div>
                <div class="tab-chart month">月</div>
            </div>
        </div>
        <div class="chart-view" id="registerStaticBox">
            <div class="tab">
                <div class="tab-chart day">天</div>
                <div class="tab-chart week">周</div>
                <div class="tab-chart month">月</div>
            </div>
        </div>
        <div class="chart-view" id="evaluationStaticBox">
            <div class="tab">
                <div class="tab-chart week">周</div>
                <div class="tab-chart month">月</div>
            </div>
        </div>
    </div>

    <!--<dl class="evaluation-list" id="evaluationList">-->
        <!--<dt>人事评价</dt>-->
        <!--&lt;!&ndash;<dd>2018-07-23</dd>&ndash;&gt;-->
        <!--&lt;!&ndash;<dd>2018-07-24</dd>&ndash;&gt;-->
    <!--</dl>-->
</div>
<div id="turnover" style="display: none; padding: 20px 20px 0;">
    <form action="" method="post" class="layui-form">
        <div class="layui-form-item">
            <label class="layui-form-label">转移渠道</label>
            <div class="layui-input-block">
                <select name="transfer_channel" id="transferChannel" lay-verify="required" lay-filter="transferChannel" lay-search>
                    <option value="0" selected>请选择</option>
                </select>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">离职时间</label>
            <div class="layui-input-block">
                <input type="text" class="layui-input" name="departure_time" id="departureTime" style="padding-left: 0;">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">离职原因</label>
            <div class="layui-input-block">
                <!--<input type="text" class="layui-input" name="departure_reason" id="departureReason" style="padding-left: 0;">-->
                <textarea name="departure_reason" id="departureReason" required lay-verify="required" placeholder="" class="layui-textarea" maxlength="100" style="resize: none; height: 100px;"></textarea>
            </div>
            <label class="layui-form-label"></label>
            <div class="layui-input-block" id="departureReasonLen" style="color: #999; text-align: right;">
                0/100
            </div>
        </div>
    </form>
</div>

<div id="evaluateTable" style="display: none;padding:20px">
    <table class="table">
        <thead>
        <tr>
            <th>人事评分</th>
            <th>人事评价</th>
            <th>纪律扣分</th>
            <th>纪律扣分原因</th>
            <th>考核周</th>
            <th>评价时间</th>
        </tr>
        </thead>
        <tbody id="evaluateTableBody">
        <!--<tr>-->
            <!--<td>人事评分</td>-->
            <!--<td>人事评价</td>-->
            <!--<td>纪律扣分</td>-->
            <!--<td>纪律扣分原因</td>-->
            <!--<td>考核周</td>-->
            <!--<td>评价时间</td>-->
        <!--</tr>-->
        </tbody>
    </table>
</div>
<script src="__PUBLIC__/js/jquery.js"></script>
<script src="__PUBLIC__/js/echarts.min.js"></script>
<script src="__PUBLIC__/js/validate.js"></script>
<script src="__PUBLIC__/js/layui/layui/layui.js"></script>
<script src="__TMPL__Public/assets/js/template.js"></script>
<script type="text/html" id="tableTemplate">
    <table class="hr-table" cellpadding="0">
        <tr>
            <td rowspan="10"><div style="width: 20px; margin: 0 auto;">基本情况</div></td>
            <td colspan="3"><label for="name"><i class="must"></i>姓名</label></td>
            <td colspan="3"><input type="text" name="name" id="name" maxlength="15" value="{{ data.info.name?data.info.name:'' }}"></td>
            <td colspan="1"><label for="nation"><i class="must"></i>民族</label></td>
            <td colspan="1"><input type="text" name="nation" id="nation" value="{{ data.info.nation?data.info.nation:'' }}"></td>
            <td colspan="2"><label for="sex"><i class="must"></i>性别</label></td>
            <td colspan="3">
                <select name="sex" id="sex" lay-verify="" lay-filter="sex">
                    <option value="0">请选择</option>
                    <option value="1" {{ data.info.sex==1?'selected':'' }}>男</option>
                    <option value="2" {{ data.info.sex==2?'selected':'' }}>女</option>
                </select>
            </td>
        </tr>
        <tr>
            <td colspan="3"><label for="birth"><i class="must"></i>出生日期</label></td>
            <td colspan="3">
                <input type="text" class="layui-input" name="birth" id="birth" style="padding-left: 0;">
            </td>
            <td colspan="2"><label for="age"><i class="must"></i>年龄</label></td>
            <td colspan="2">
                <input type="text" name="age" id="age" value="{{ data.info.age?data.info.age:'' }}">
            </td>
            <td colspan="3" rowspan="4" class="picture-box" id="pictureBox">
                <div class="file" id="fileImg" style="display: none;">选择图片
                    <input type="file" name="img" id="img" multiple="multiple" accept="image/gif, image/jpeg, image/png, image/jpg">
                </div>
                <div class="picture-img" id="pictureImg" style="display: none;">
                    <img src="{{ data.info.img?data.info.img:'' }}" class="picture">
                    <i class="picture-clear"></i>
                </div>
            </td>
        </tr>
        <tr>
            <td colspan="3"><label for="politicalAffiliation"><i class="must"></i>政治面貌</label></td>
            <td colspan="3"><input type="text" name="political_affiliation" id="politicalAffiliation" value="{{ data.info.political_affiliation?data.info.political_affiliation:'' }}"></td>
            <td colspan="2"><label for="marriage"><i class="must"></i>婚姻状况</label></td>
            <td colspan="2">
                <select name="marriage" id="marriage" lay-verify="" lay-filter="marriage">
                    <option value="0">请选择</option>
                    <option value="1" {{ data.info.marriage==1?'selected':'' }}>未婚</option>
                    <option value="2" {{ data.info.marriage==2?'selected':'' }}>已婚</option>
                    <option value="3" {{ data.info.marriage==3?'selected':'' }}>离异</option>
                </select>
            </td>
        </tr>
        <tr>
            <td colspan="3"><label for="graduateSchool"><i class="must"></i>毕业学校</label></td>
            <td colspan="3"><input type="text" name="graduate_school" id="graduateSchool" value="{{ data.info.graduate_school?data.info.graduate_school:'' }}"></td>
            <td colspan="2"><label for="graduateTime"><i class="must"></i>毕业时间</label></td>
            <td colspan="2">
                <input type="text" class="layui-input" name="graduate_time" id="graduateTime" style="padding-left: 0;">
            </td>
        </tr>
        <tr>
            <td colspan="3"><label for="education"><i class="must"></i>学历</label></td>
            <td colspan="3">
                <select name="education" id="education" lay-verify="" lay-filter="education">
                    <option value="0" selected>请选择</option>
                    <option value="1" {{ data.info.education==1?'selected':'' }}>专科</option>
                    <option value="2" {{ data.info.education==2?'selected':'' }}>本科</option>
                    <option value="3" {{ data.info.education==3?'selected':'' }}>硕士</option>
                    <option value="4" {{ data.info.education==4?'selected':'' }}>博士</option>
                    <option value="5" {{ data.info.education==5?'selected':'' }}>其他</option>
                </select>
            </td>
            <td colspan="2"><label for="major"><i class="must"></i>专业</label></td>
            <td colspan="2"><input type="text" name="major" id="major" value="{{ data.info.major?data.info.major:'' }}"></td>
        </tr>
        <tr>
            <td colspan="3"><label for="mobile">手机</label></td>
            <td colspan="3">
                <input type="text" name="mobile" id="mobile" maxlength="11" value="{{ data.info.mobile?data.info.mobile:'' }}">
            </td>
            <td colspan="2"><label for="idCard">身份证号码</label></td>
            <td colspan="5"><input type="text" name="id_card" id="idCard" value="{{ data.info.id_card?data.info.id_card:'' }}"></td>
        </tr>
        <tr>
            <td colspan="3"><label for="qq">qq号码</label></td>
            <td colspan="3"><input type="text" name="qq" id="qq" value="{{ data.info.qq?data.info.qq:'' }}"></td>
            <td colspan="2"><label for="weixin">微信号</label></td>
            <td colspan="5"><input type="text" name="weixin" id="weixin" value="{{ data.info.weixin?data.info.weixin:'' }}"></td>
        </tr>
        <tr>
            <td colspan="3"><label for="agencyMobile">紧急联系人<br>姓名and电话</label></td>
            <td colspan="3"><input type="text" name="agency_mobile" id="agencyMobile" value="{{ data.info.agency_mobile?data.info.agency_mobile:'' }}"></td>
            <td colspan="2"><label for="email">Email</label></td>
            <td colspan="5"><input type="email" name="email" id="email" value="{{ data.info.email?data.info.email:'' }}"></td>
        </tr>
        <tr>
            <td colspan="3"><label for="residenceAddress">户籍详细地址</label></td>
            <td colspan="10"><input type="text" name="residence_address" id="residenceAddress" maxlength="100" value="{{ data.info.residence_address?data.info.residence_address:'' }}"></td>
        </tr>
        <tr>
            <td colspan="3"><label for="address">现居住详细地址</label></td>
            <td colspan="10"><input type="text" name="address" id="address" maxlength="100" value="{{ data.info.address?data.info.address:'' }}"></td>
        </tr>
        <tr>
            <td rowspan="6"><div style="width: 20px; margin: 0 auto;">入离职情况</div></td>
            <td colspan="3"><label for="channelLegion">所属地区</label></td>
            <td colspan="3">
                <select name="channel_legion" id="channelLegion" lay-verify="" lay-filter="channelLegion" disabled>
                    <option value="0" selected>{{ data.info.channel_legion?data.info.channel_legion:'' }}</option>
                </select>
            </td>
            <td colspan="2"><label for="parentChannel">所属团队</label></td>
            <td colspan="5">
                <select name="parent_channel" id="parentChannel" lay-verify="" lay-filter="parentChannel" disabled>
                    <option value="0" selected>{{ data.info.parent_channel?data.info.parent_channel:'' }}</option>
                </select>
            </td>
        </tr>
        <tr>
            <td colspan="3"><label for="channel">渠道号</label></td>
            <td colspan="10">
                <select name="channel" id="channel" lay-verify="" lay-filter="channel" disabled>
                    <option value="0" selected>{{ data.info.channel?data.info.channel:'' }}</option>
                </select>
            </td>
        </tr>
        <tr>
            <td colspan="3">入职时间</td>
            <td colspan="3"><input type="text" class="layui-input" name="hire_date" id="hireDate" style="padding-left: 0;"></td>
            <!--<td colspan="3" class="disabled">{{ data.info.hire_date }}</td>-->
            <td colspan="2">离职时间</td>
            {{if data.info.departure_time&&data.info.departure_time!=0}}
            <td colspan="5" class="disabled">
                {{ data.info.departure_time }}
            </td>
            {{else}}
            <td colspan="5">
                <!--<button class="layui-btn">办理离职</button>-->
                <input type="button" class="button" style="background-color: #009f95; border-color: #009f95;" id="quitBtn" value="办理离职">
            </td>
            {{/if}}
        </tr>
        <tr>
            <td colspan="3"><label for="trialDays">试用天数</label></td>
            <td colspan="3"><input type="text" name="trial_days" id="trialDays" value="{{ data.info.trial_days?data.info.trial_days:'' }}"></td>
            <td colspan="2"><label for="regularTime">转正时间</label></td>
            <td colspan="5"><input type="text" class="layui-input" name="regular_time" id="regularTime" style="padding-left: 0;"></td>
        </tr>
        <tr>
            <td colspan="3"><label for="contractExpiration">合同到期时间</label></td>
            <td colspan="3"><input type="text" class="layui-input" name="contract_expiration" id="contractExpiration" style="padding-left: 0;"></td>
            <td colspan="2"><label for="archivesLocation">档案所在地</label></td>
            <td colspan="5"><input type="text" name="archives_location" id="archivesLocation" style="padding-left: 0;" value="{{ data.info.archives_location?data.info.archives_location:'' }}"></td>
        </tr>
        <tr>
            <td colspan="3">离职原因</td>
            <td colspan="10" class="disabled">{{ data.info.departure_reason?data.info.departure_reason:'' }}</td>
        </tr>
        <tr>
            <td rowspan="4"><div style="margin: 0 5px;">评分扣分及评价</div></td>
            <td colspan="3"><label for="evaluateTime">考核周</label></td>
            <td colspan="10">
                <div class="time-view">
                    <div class="time-text"></div>
                    <input type="text" class="layui-input time-input" name="time" id="evaluateTime" style="padding-left: 0;">
                </div>
            </td>
        </tr>
        <tr>
            <td colspan="3"><label for="score">人事评分</label></td>
            <td colspan="3"><input type="text" name="score" id="score" value="{{ data.lastweek_evaluation.score?data.lastweek_evaluation.score:'' }}"></td>
            <td colspan="2"><label for="deductMarks">纪律扣分</label></td>
            <td colspan="5"><input type="text" name="deduct_marks" id="deductMarks" value="{{ data.lastweek_evaluation.deduct_marks?data.lastweek_evaluation.deduct_marks:'' }}"></td>
        </tr>
        <tr>
            <td colspan="3"><label for="evaluation">人事评价</label></td>
            <td colspan="10"><input type="text" name="evaluation" id="evaluation" value="{{ data.lastweek_evaluation.evaluation?data.lastweek_evaluation.evaluation:'' }}" maxlength="100"></td>
        </tr>
        <tr>
            <td colspan="3"><label for="deductReason">纪律扣分原因</label></td>
            <td colspan="10"><input type="text" name="deduct_reason" id="deductReason" value="{{ data.lastweek_evaluation.deduct_reason?data.lastweek_evaluation.deduct_reason:'' }}" maxlength="100"></td>
        </tr>
        <tr>
            <td colspan="14">
                <!--<input type="button" value="提交" class="btn">-->
                <input type="submit" name="submit" class="button" value="提交">
            </td>
        </tr>
        <tr style="visibility: hidden;">
            <td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td>
        </tr>
    </table>
</script>
<script>
    $(function () {


        layui.use(['jquery', 'layer', 'form', 'element','laydate'], function() {
            var layer = layui.layer//重点处
                , form = layui.form
                , element = layui.element
                , laydate = layui.laydate;
            function timestampToTime(timestamp, type) {
                type = type || '';
                // if(timestamp.length < 13){
                //     timestamp = timestamp * 1000;
                // }
                var date = new Date(timestamp);
                var Y = date.getFullYear() + '-';
                var M = (date.getMonth()+1 < 10 ? '0'+(date.getMonth()+1) : date.getMonth()+1) + '-';
                var D = (date.getDate() < 10 ? '0'+date.getDate() : date.getDate());

                var hour = (date.getHours() < 10 ? '0'+date.getHours() : date.getHours());
                var minute = (date.getMinutes() < 10 ? '0'+date.getMinutes() : date.getMinutes());
                var second = (date.getSeconds() < 10 ? '0'+date.getSeconds() : date.getSeconds());
                if(type === 'second'){
                    return Y+M+D+' '+hour+':'+minute+':'+second;
                }
                return Y+M+D;
            }

            var getWeekInterval = function (y, m, d) {
                var date = '';
                if(y && m && d){
                    date = new Date(y, parseInt(m, 10) - 1, d);
                } else {
                    date = new Date();
                }

                var getDay = date.getDay() === 0 ? 7 : date.getDay();
                var timestamp = date.getTime();
                var startTime = timestamp - ((getDay-1) * 24 * 3600 * 1000);
                var endTime = timestamp + ((7 - getDay) * 24 * 3600 * 1000);
                return timestampToTime(startTime) + '至' + timestampToTime(endTime);
            };




            //员工流水统计
            $.ajax({
                type: 'post',
                url: '/index.php?g=api&m=TgEmployees&a=info',
                data: {
                    id: '{$id}' //员工ID
                },
                success: function(datas){
//                    console.log(datas);
                    if(datas.status == 1){
                        var data = datas.data;
                        var info = data.info;
                        //入职时间
                        // if(info.hire_date == 0){
                        //     info.hire_date = info.hire_date;
                        // } else if(!info.hire_date){
                        //     info.hire_date = '';
                        // } else {
                        //     info.hire_date = timestampToTime(info.hire_date);
                        // }
                        //离职时间
//                        if(info.departure_time == 0){
//                            info.departure_time = info.departure_time;
//                        } else if(!info.departure_time){
//                            info.departure_time = '';
//                        } else {
//                            info.departure_time = timestampToTime(info.departure_time);
//                        }
                        if(info.departure_time && info.departure_time!=0) {
                            info.departure_time = timestampToTime(info.departure_time*1000);
                        } else {
                            //离职表单
                            //转移渠道列表
                            $.ajax({
                                type: 'post',
                                url: '/index.php?g=api&m=TgEmployees&a=transfer_channel_list',
                                data: {
                                    id: '{$id}' //员工ID
                                },
                                success: function(datas){
                                    if(datas.status == 1){
                                        if(datas.data){
                                            var data = datas.data;
                                            var html = '<option value="1">111</option>';
                                            for(var i = 0; i < data.length; i++){
                                                html = '<option value="'+ data[i].id +'">'+ data[i].name +'</option>';
                                                $('#transferChannel').append($(html));
                                            }
                                        }
                                        form.render('select');
                                    }
                                    if(datas.status == 0){
                                        console.log(datas.msg);
                                    }

                                },
                                error: function (err) {
                                    console.log(err);
                                }
                            });
                            //转移渠道
                            form.on('select(transferChannel)', function(data){});
                            //离职时间
                            laydate.render({elem: '#departureTime'});
                            $('#departureReason').keyup(function () {
                                $('#departureReasonLen').html(this.value.length+'/100');
                            });
                        }
                        var html = template('tableTemplate',{'data':{
                            info: info,
                            lastweek_evaluation: datas.data.lastweek_evaluation
                        }});
                        $('#addForm').html(html);


                        if(info.img){
                            $('#pictureImg').show();
                        } else {
                            $('#fileImg').show();
                        }
                        //性别
                        form.on('select(sex)', function(data){
//                            console.log(data.value);
                        });
                        //出生日期
                        if(info.birth && info.birth!=0){
                            laydate.render({
                                elem: '#birth'
                                ,value: timestampToTime(info.birth*1000)
                            });
                        } else {
                            laydate.render({elem: '#birth'});
                        }
                        //婚姻状况
                        form.on('select(marriage)', function(data){});
                        //毕业时间
                        if(info.graduate_time && info.graduate_time!=0){
                            laydate.render({
                                elem: '#graduateTime'
                                ,value: timestampToTime(info.graduate_time*1000)
                            });
                        } else {
                            laydate.render({elem: '#graduateTime'});
                        }
                        //学历
                        form.on('select(education)', function(data){});
                        //入职时间
                       if(info.hire_date && info.hire_date!=0){
                           laydate.render({
                               elem: '#hireDate'
                               ,value: timestampToTime(info.hire_date*1000)
                           });
                       } else {
                           laydate.render({elem: '#hireDate'});
                       }
//                        //离职时间
//                        if(info.departure_time && info.departure_time!=0){
//                            laydate.render({
//                                elem: '#departureTime'
//                                ,value: timestampToTime(info.departure_time)
//                            });
//                        } else {
//                            laydate.render({elem: '#departureTime'});
//                        }
                        //转正时间
                        if(info.regular_time && info.regular_time!=0){
                            laydate.render({
                                elem: '#regularTime'
                                ,value: timestampToTime(info.regular_time*1000)
                            });
                        } else {
                            laydate.render({elem: '#regularTime'});
                        }
                        //合同到期时间
                        if(info.contract_expiration && info.contract_expiration!=0){
                            laydate.render({
                                elem: '#contractExpiration'
                                ,value: timestampToTime(info.contract_expiration*1000)
                            });
                        } else {
                            laydate.render({elem: '#contractExpiration'});
                        }



//                        $('.time-text').html(getWeekInterval());
                        var dateTimestamp = new Date().getTime() - (24 * 3600 * 1000 * 7);
                        dateTimestamp = timestampToTime(dateTimestamp);
                        var dateTimestampArr = dateTimestamp.split('-');
                        $('.time-text').html(getWeekInterval(dateTimestampArr[0], dateTimestampArr[1], dateTimestampArr[2]));
                        //评价时间
                        laydate.render({
                            elem: '#evaluateTime'
                            ,value: (function() {
                                var date = new Date();
                                var Y = date.getFullYear();
//                                var M = (date.getMonth()+1 < 10 ? '0'+(date.getMonth()+1) : date.getMonth()+1) + '-';
                                var M = date.getMonth();
                                var D = date.getDate();
                                if(D > 7){
                                    Y = Y + '-';
                                    M = M + 1 + '-';
                                    D = D - 7;
                                    D = (D < 10 ? '0'+D : D);
                                } else {
                                    if(M > 0){
                                        D = new Date(Y, M, 0).getDate() + D - 7;
                                        M = (M < 10 ? '0'+M : M) + '-';
                                        Y = Y + '-';
                                    } else {
                                        D = new Date(Y-1, 12, 0).getDate() + D - 7;
                                        M = 12 + '-';
                                        Y = Y - 1 + '-';
                                    }
                                }
                                return Y+M+D;
//                                return datas.data.lastweek_evaluation.period;
                            })()
                            ,done: function(value, date, endDate){
//                                console.log(value); //得到日期生成的值，如：2017-08-18
                                $.ajax({
                                    url: '/index.php?g=api&m=TgEmployees&a=evaluation_info',
                                    type: 'post',
                                    data:{
                                        id: '{$id}',
                                        time: value //考核周（一周的任意一天）
                                    },
                                    success: function (datas) {
                                        if(datas.status == 1){
                                            if(datas.data){
                                                var data = datas.data;
                                                $('#score').val(data.score);
                                                $('#deductMarks').val(data.deduct_marks);
                                                $('#evaluation').val(data.evaluation);
                                                $('#deductReason').val(data.deduct_reason);

                                                $('.time-text').html(data.period);
                                            } else {
                                                $('#score').val('');
                                                $('#deductMarks').val('');
                                                $('#evaluation').val('');
                                                $('#deductReason').val('');

                                                var valueArr = value.split('-');
                                                $('.time-text').html(getWeekInterval(valueArr[0], valueArr[1], valueArr[2]));
                                            }
                                        }
                                        if(datas.status == 0){
                                            console.log(datas.msg);
                                        }
                                    },
                                    error: function (err) {
                                        console.log(err);
                                    }
                                });
                            }
                        });


                        form.render('select');

                        //上传图片
                        $('#pictureImg').on('click','.picture-clear',function () {
                            $('#pictureImg').hide();
                            $('#img').val('');
                            $('#fileImg').show();
                        });
                        $('#img').on('change', function(e) {
                            var files = e.target.files || e.dataTransfer.files;
                            if (!files.length) return;
                            this.picValue = files[0];
                            imgPreview(this.picValue);
                        });
                        function imgPreview (file) {
                            var _this = this;
                            // 看支持不支持FileReader
                            if (!file || !window.FileReader) return;
                            if (/^image/.test(file.type)) {
                                // 创建一个reader
                                var reader = new FileReader();
                                // 将图片2将转成 base64 格式
                                reader.readAsDataURL(file);

                                // 读取成功后的回调
                                reader.onloadend = function () {
                                    var result = this.result;
//                    var img = new Image();
                                    var html = '<img src="'+ result +'" class="picture"><i class="picture-clear"></i>';
                                    $('#pictureImg').html(html);
                                    $('#fileImg').hide();
                                    $('#pictureImg').show();
                                }
                            }
                        };


                        if(data.money_static){
                            var moneyStatic = data.money_static,
                                moneyStaticKey = [],
                                moneyStaticValue = [];
                            for(var key in moneyStatic){
                                moneyStaticKey.push(key);
                                moneyStaticValue.push(moneyStatic[key]);
                            }
                            var moneyStaticChart = newChart({
                                id: 'moneyStaticBox',
                                url: '/index.php?g=api&m=TgEmployees&a=money_static',//员工流水统计
                                title: '流水',
                                unit: '金额（元）',
                                name: '流水',
                                type: 1,
                                data: moneyStaticValue,
                                time: moneyStaticKey
                            });
                        } else {
                            $('#moneyStaticBox').hide();
                        }

                        if(data.register_static){
                            var registerStatic = data.register_static,
                                registerStaticKey = [],
                                registerStaticValue = [];
                            for(var key in moneyStatic){
                                registerStaticKey.push(key);
                                registerStaticValue.push(registerStatic[key]);
                            }
                            newChart({
                                id: 'registerStaticBox',
                                url: '/index.php?g=api&m=TgEmployees&a=register_static',//员工注册统计
                                title: '注册',
                                unit: '人数',
                                name: '注册人数',
                                type: 1,
                                data: registerStaticValue,
                                time: registerStaticKey
                            });
                        } else {
                            $('#registerStaticBox').hide();
                        }

                        if(data.evaluation_static){
                            var evaluationStatic = data.evaluation_static,
                                evaluationStaticKey = [],
                                evaluationStaticValue = [];
                            for(var key in evaluationStatic){
                                evaluationStaticKey.push(key);
                                evaluationStaticValue.push(evaluationStatic[key]);
                            }
                            newChart({
                                id: 'evaluationStaticBox',
                                url: '/index.php?g=api&m=TgEmployees&a=evaluation_static',//人事评分统计
                                title: '人事评分',
                                unit: '分数',
                                name: '得分',
                                type: 2,
                                data: evaluationStaticValue,
                                time: evaluationStaticKey
                            });
                        } else {
                            $('#evaluationStaticBox').hide();
                        }
//                        $('.chart-view').show();
                        if(data.evaluation_list && data.evaluation_list.length > 0){
                            var evaluationList = data.evaluation_list;
                            var evaluationListHtml = '<dt>人事评价</dt>';
                            for(var i = 0; i < evaluationList.length; i++){
                                evaluationListHtml += '<dd data-id="'+ evaluationList[i].id +'">'+ timestampToTime(evaluationList[i].create_time*1000, 'second') +' 人事进行了评价'+'</dd>';
                            }
                            $('#evaluationList').html(evaluationListHtml);
                            $('#evaluationList').show();
                        } else {
                            $('#evaluationList').hide();
                        }


                        newEditvalidate();
                        $('#quitBtn').on('click', function () {
//                            layer.open({
//                                title: '办理离职'
//                                ,content: '可以填写任意的layer代码'
//                                ,skin: 'layui-layer-molv'//layui-layer-molv layui-layer-lan
//                            });
                            layer.open({
                                title: '办理离职',
                                type: 1,
                                skin: 'layui-layer-molv', //加上边框
                                area: ['800px', 'auto'], //宽高
                                content: $('#turnover'),
//                                closeBtn: 0, //不显示关闭按钮
                                anim: 2,
                                btnAlign: 'c',
                                shadeClose: false, //开启遮罩关闭
                                btn: ['提交'],
                                yes: function(index, layero){
                                    if(!$('#departureTime').val()){
                                        layer.msg('请填写离职时间');
                                    } else if(!$('#departureReason').val()){
                                        layer.msg('请填写离职原因');
                                    } else {
                                        layer.open({
                                            title: '提示'
                                            ,content: '确定离职操作?'
                                            ,btn: ['确定', '取消']
                                            ,yes: function(index, layero){
                                                //按钮【按钮一】的回调
                                                var load = layer.load(2, {
                                                    time: 30*1000,
                                                    shade: [0.3, '#000']
                                                });
                                                $.ajax({
                                                    type: 'post',
                                                    url: '/index.php?g=api&m=TgEmployees&a=turnover',
                                                    data: {
                                                        id: '{$id}',
                                                        departure_time: $('#departureTime').val(),  //离职时间
                                                        departure_reason: $('#departureReason').val(),  //离职原因
                                                        transfer_channel: $('#transferChannel').val()  //转移渠道（0 为不转移）
                                                    },
                                                    success: function (datas) {
                                                        layer.close(load); //关闭加载遮罩
                                                        layer.close(index);
                                                        if(datas.status == 1){
                                                            location.href = location.href;
                                                        }
                                                        if(datas.status == 0){
                                                            layer.msg(datas.msg);
                                                        }
                                                    },
                                                    error: function (err) {
                                                        console.log(err);
                                                        layer.close(load); //关闭加载遮罩
                                                        layer.close(index);
                                                    }
                                                });
                                            }
                                            ,btn2: function(index, layero){
                                                //按钮【按钮二】的回调
                                                //return false 开启该代码可禁止点击该按钮关闭
                                            }
                                            ,cancel: function(){
                                                //右上角关闭回调
                                                //return false 开启该代码可禁止点击该按钮关闭
                                            }
                                        });
                                    }
                                }
                            });
                        });
                    }
                    if(datas.status == 0){
                        console.log(datas.msg);
                    }
                },
                error: function (err){
                    console.log(err)
                }
            });

            //人事评价详情
            $('#evaluationList').on('click', 'dd', function (event) {
                var load = layer.load(2, {
                    time: 30*1000,
                    shade: [0.3, '#000']
                });
                $.ajax({
//                    url: '/index.php?g=api&m=TgEmployees&a=evaluation_info',
                    url: '/index.php?g=api&m=TgEmployees&a=evaluation_list',
                    type: 'post',
                    data:{
                        id: '{$id}'
//                        ,time: this.innerHTML //考核周（一周的任意一天）
                    },
                    success: function (datas) {
                        layer.close(load);
                        if(datas.status == 1){
                            var data = datas.data;
                            //var html = '<p>人事评分：'+ data.score +'</p><p>纪律扣分：'+ data.deduct_marks +'</p><p>人事评价：'+ data.evaluation +'</p><p>纪律扣分原因：'+ data.deduct_reason +'</p><p>考核周：'+ data.period +'</p><p>评价时间：'+ timestampToTime(data.create_time, 'second') +'</p>';
//                            layer.open({
//                                title: '详情'
//                                ,content: html
//                            });
                            if(data && data.length > 0){
                                var html = '';
                                for(var i = 0; i < data.length; i++){
                                    html += '<tr>'+
                                            '<td>'+data[i].score+'</td>'+
                                            '<td>'+data[i].evaluation+'</td>'+
                                            '<td>'+data[i].deduct_marks+'</td>'+
                                            '<td>'+data[i].deduct_reason+'</td>'+
                                            '<td>'+data[i].period+'</td>'+
                                            '<td>'+timestampToTime(data[i].create_time*1000, 'second')+'</td>'+
                                        '</tr>';
                                }
                                $('#evaluateTableBody').html(html);
                            }
                            layer.open({
                                title: '人事评价表格',
                                type: 1,
                                skin: 'layui-layer-molv', //加上边框
                                area: ['800px', 'auto'], //宽高
                                content: $('#evaluateTable'),
                                closeBtn: 0, //不显示关闭按钮
                                anim: 2,
                                btnAlign: 'c',
                                shadeClose: false, //开启遮罩关闭
                                btn: ['关闭'],
                                yes: function(index, layero){
                                    layer.close(index)
                                }
                            });
                        }
                        if(datas.status == 0){
                            console.log(datas.msg);
                        }
                    },
                    error: function (err) {
                        console.log(err);
                        layer.close(load);
                    }
                });
            });

            function newChart(param) {
                var chartHtml = document.createElement('div');
                chartHtml.className = 'chart';
//            obj.box.appendChild(chartHtml);
                $('#'+param.id).show();
                document.getElementById(param.id).appendChild(chartHtml);

                // 基于准备好的dom，初始化echarts实例
                var myChart = echarts.init(chartHtml);
                myChart.showLoading();	//加载动画
                // 指定图表的配置项和数据
                myChart.setOption({
                    title: {
                        text: param.title
                    },
                    color: '#5793f3',
                    tooltip: {  //提示框组件
                        trigger: 'axis',
                        axisPointer: {  // 坐标轴指示器，坐标轴触发有效
                            type: 'cross'   // 默认为直线，可选为：'line' | 'shadow'
                        }
                    },
                    toolbox: {  //工具栏。内置有导出图片，数据视图，动态类型切换，数据区域缩放，重置五个工具。
                        feature: {  //自定义工具按钮(只能以 my 开头)
                            dataView: {show: true, readOnly: false},
                            restore: {show: true},
                            saveAsImage: {show: true}
                        }
                    },
                    xAxis: {
//                    name: '天',
                        name: (function (type) {
                            if(type == 1){
                                return '天';
                            } else if (type == 2){
                                return '周';
                            } else if (type == 3){
                                return '月';
                            }
                        })(param.type),
                        type: 'category',
                        data: param.time
                    },
                    yAxis: [
                        {
                            type: 'value',
                            name: param.unit
                        }
                    ],
                    series: [
                        {
                            name: param.name,
                            type: 'line',
                            itemStyle : { normal: {label : {show: true}}},  //显示数值
//                            yAxisIndex: 1,
//                            symbolSize: 5,
                            data: param.data
                        }
                    ]
                });
                myChart.hideLoading(); // 隐藏加载动画


                var dayFlag = true;
                $('#'+param.id).on('click', '.day', function () {
                    if(dayFlag){
                        dayFlag = false;
                        myChart.showLoading();	//加载动画
                        $('#moneyStaticBox .day').unbind('click');
                        $.ajax({
                            type: 'post',
                            url: param.url,
                            data: {
                                id: '{$id}', //员工ID
                                type: 1 //统计类型 1 天 2 周 3 月
                            },
                            success: function(datas){
                                if(datas.status == 1){
                                    var moneyStatic = datas.data,
                                        moneyStaticKey = [],
                                        moneyStaticValue = [];
                                    for(var key in moneyStatic){
                                        moneyStaticKey.push(key);
                                        moneyStaticValue.push(moneyStatic[key]);
                                    }
                                    myChart.setOption({
                                        xAxis: {
                                            name: '天',
                                            data: moneyStaticKey
                                        },
                                        series: [
                                            {
                                                data: moneyStaticValue
                                            }
                                        ]
                                    });
                                }
                                if(datas.status == 0){
                                    console.log(datas.msg);
                                }
                                myChart.hideLoading(); // 隐藏加载动画
                                dayFlag = true;
                            },
                            error: function (err) {
                                console.log(err);
                                myChart.hideLoading(); // 隐藏加载动画
                                dayFlag = true;
                            }
                        });
                    }
                });

                var weekFlag = true;
                $('#'+param.id).on('click', '.week', function () {
                    if(weekFlag){
                        weekFlag = false;
                        myChart.showLoading();	//加载动画
                        //员工流水统计
                        $.ajax({
                            type: 'post',
                            url: param.url,
                            data: {
                                id: '{$id}', //员工ID
                                type: 2 //统计类型 1 天 2 周 3 月
                            },
                            success: function(datas){
                                if(datas.status == 1){
                                    var moneyStatic = datas.data,
                                        moneyStaticKey = [],
                                        moneyStaticValue = [];
                                    for(var key in moneyStatic){
                                        moneyStaticKey.push(key);
                                        moneyStaticValue.push(moneyStatic[key]);
                                    }
                                    myChart.setOption({
                                        xAxis: {
                                            name: '周',
                                            data: moneyStaticKey
                                        },
                                        series: [
                                            {
                                                data: moneyStaticValue
                                            }
                                        ]
                                    });
                                }
                                if(datas.status == 0){
                                    console.log(datas.msg);
                                }
                                myChart.hideLoading(); // 隐藏加载动画
                                weekFlag = true;
                            },
                            error: function (err) {
                                console.log(err);
                                myChart.hideLoading(); // 隐藏加载动画
                                weekFlag = true;
                            }
                        });
                    }

                });

                var monthFlag = true;
                $('#'+param.id).on('click', '.month', function () {
                    if(monthFlag){
                        monthFlag = false;
                        myChart.showLoading();	//加载动画
                        $('#moneyStaticBox .month').unbind('click');
                        $.ajax({
                            type: 'post',
                            url: param.url,
                            data: {
                                id: '{$id}', //员工ID
                                type: 3 //统计类型 1 天 2 周 3 月
                            },
                            success: function(datas){
                                if(datas.status == 1){
                                    var moneyStatic = datas.data,
                                        moneyStaticKey = [],
                                        moneyStaticValue = [];
                                    for(var key in moneyStatic){
                                        moneyStaticKey.push(key);
                                        moneyStaticValue.push(moneyStatic[key]);
                                    }
                                    myChart.setOption({
                                        xAxis: {
                                            name: '月',
                                            data: moneyStaticKey
                                        },
                                        series: [
                                            {
                                                data: moneyStaticValue
                                            }
                                        ]
                                    });
                                }
                                if(datas.status == 0){
                                    console.log(datas.msg);
                                }
                                myChart.hideLoading(); // 隐藏加载动画
                                monthFlag = true;
                            },
                            error: function (err) {
                                console.log(err);
                                myChart.hideLoading(); // 隐藏加载动画
                                monthFlag = true;
                            }
                        });
                    }
                });
            }

            function newEditvalidate() {
// 在键盘按下并释放及提交后验证提交表单
                $("#addForm").validate({
//                debug: true,
                    rules: {
                        name: {
                            required: true,
                            minlength: 2,
                            maxlength: 15
                        },
                        nation: "required", //民族
                        sex: "isSex",
                        birth: "required",
                        age: "required",
                        political_affiliation: "required", //政治面貌
                        marriage: "isMarriage",//婚姻状况
                        graduate_school: "required", //毕业学校
                        graduate_time: "required", //毕业时间
                        education: "isEducation",//学历
                        major: "required", //专业
                        img: {
                            accept: "JPG|JPEG|PNG|GIF"
                        },
                        mobile: "isMobile",//手机号
                        id_card: "isIdCard",
                        qq: {
                            digits: true
                        },
                        weixin: {
                            minlength: 6,
                            maxlength: 20
                        },
                        agency_mobile: { //紧急联系人姓名and电话
                            minlength: 11,
                            maxlength: 30
                        },
                        residence_address: { //户籍地址
                            maxlength: 100
                        },
                        address: { //现居住地址
                            maxlength: 100
                        },
                        email: {
                            email: true
                        },
                        channel_legion: "isChannelLegion",//所属地区
                        parent_channel: "isParentChannel",//所属团队
                        channel: "isChannel",//渠道号
                        hire_date: "required", //入职时间
                        trial_days: {
                            digits: true
                        },
                        archives_location: { //档案所在地
                            maxlength: 100
                        }
                    },
                    messages: {
                        name: {
                            required: "请输入姓名",
                            minlength: "姓名必需由2-15个字符组成",
                            maxlength: "姓名必需由2-15个字符组成"
                        },
                        nation: {
                            required: "请填写民族"
                        },
                        birth: {
                            required: "请选择出生日期"
                        },
                        age: {
                            required: "请填写年龄"
                        },
                        political_affiliation: {
                            required: "请填写政治面貌"
                        },
                        graduate_school: {
                            required: "请填写毕业学校"
                        },
                        graduate_time: {
                            required: "请选择毕业时间"
                        },
                        major: {
                            required: "请填写专业"
                        },
                        qq: {
                            digits: "请填写无特殊字符的数字"
                        },
                        weixin: {
                            minlength: "微信号不能少于6个字符",
                            maxlength: "微信号不能大于20个字符"
                        },
                        agency_mobile: {
                            minlength: "紧急联系人姓名and电话不能小于11个字符",
                            maxlength: "紧急联系人姓名and电话不能大于30个字符"
                        },
                        residence_address: {
                            maxlength: "户籍地址不能大于100个字符"
                        },
                        address: {
                            maxlength: "现居住地址不能大于100个字符"
                        },
                        hire_date: {
                            required: "请填写入职时间"
                        },
                        trial_days: {
                            digits: "请输入整数数字"
                        },
                        archives_location: {
                            maxlength: "档案所在地不能大于100个字符"
                        }
                    },
                    success: function(label) {
                        $('#msgError').hide();
                    },
                    errorContainer: "#msgError",
//            errorLabelContainer: "#msgError",
                    errorPlacement: function(error, element) {
                        $('#msgError').html(error);
                    },
                    showErrors :function(errorMap,errorList){
                        if(errorList[0]){
                            if(errorList[0].message){
                                $('#msgError').html(errorList[0].message);
                                $('#msgError').show();
                            }
                        }
                    },
                    submitHandler:function(form) {
                        $('#msgError').hide();

                        layer.open({
                            title: '提示'
                            ,content: '确定修改信息?'
                            ,btn: ['确定', '取消']
                            ,yes: function(index, layero){
                                //按钮【按钮一】的回调
                                var load = layer.load(2, {
                                    time: 30*1000,
                                    shade: [0.3, '#000']
//                                  shadeClose : true
                                });

                                var imgInput = document.getElementById('img');
                                if($('#pictureImg').css('display') == 'none'){
                                    imgInput.setAttribute("type", "text");
                                }

                                var xhr = new XMLHttpRequest();
                                xhr.open('post', '/index.php?g=api&m=TgEmployees&a=edit');
                                xhr.onreadystatechange = function () {
                                    if (xhr.readyState == 4 && xhr.status == 200) {
                                        layer.close(load); //关闭加载遮罩
                                        layer.close(index);
                                        var datas = JSON.parse(xhr.responseText);
                                        if(datas.status == 1){
                                            layer.msg(datas.msg);
                                            location.href = location.href;
                                        }
                                        if(datas.status == 0){
                                            layer.msg(datas.msg);
                                        }
                                    } else {
                                        layer.close(load);
                                        layer.close(index);
                                    }
                                };
                                // XHR2.0新增 上传进度监控
                                xhr.upload.onprogress = function (event) {
                                    //  console.log(event);
                                    var percent = event.loaded / event.total * 100 + '%';
//                                  console.log(percent);
                                    // 设置 进度条内部step的 宽度
//                                  document.querySelector('.step').style.width = percent;
                                }
                                // XHR2.0新增
                                var formData = new FormData(document.getElementById('addForm'));
                                formData.append("id", "{$id}");
//                              console.log(formData.get("id"));
                                xhr.send(formData);
                            }
                            ,btn2: function(index, layero){
                                //按钮【按钮二】的回调
                                //return false 开启该代码可禁止点击该按钮关闭
                            }
                            ,cancel: function(){
                                //右上角关闭回调
                                //return false 开启该代码可禁止点击该按钮关闭
                            }
                        });
                    }
                });
                $.validator.addMethod("isSex",function(value,element,params){
                    if(value == 0 || !value){
                        return false;
                    } else {
                        return true;
                    }
                }, "请选择性别");
                $.validator.addMethod("isMarriage",function(value,element,params){
                    if(value == 0 || !value){
                        return false;
                    } else {
                        return true;
                    }
                }, "请选择婚姻状况");
                $.validator.addMethod("isChannelLegion",function(value,element,params){
                    if(value == 0 || !value){
                        return false;
                    } else {
                        return true;
                    }
                }, "请选择所属地区");
                $.validator.addMethod("isEducation",function(value,element,params){
                    if(value == 0 || !value){
                        return false;
                    } else {
                        return true;
                    }
                }, "请选择最高学历");
                $.validator.addMethod("isParentChannel",function(value,element,params){
                    if(value == 0 || !value){
                        return false;
                    } else {
                        return true;
                    }
                }, "请选择所属团队");
                $.validator.addMethod("isChannel",function(value,element,params){
                    if(value == 0 || !value){
                        return false;
                    } else {
                        return true;
                    }
                }, "请选择渠道号");
                //手机号验证
                $.validator.addMethod("isMobile", function(value, element) {
                    var tel = /^1\d{10}$/;
                    return this.optional(element) || (tel.test(value));
                }, "请正确填写您的手机号码");
                //身份证号码验证
                $.validator.addMethod("isIdCard", function(value, element) {
                    var tel1 = /^[1-9]\d{5}(18|19|([23]\d))\d{2}((0[1-9])|(10|11|12))(([0-2][1-9])|10|20|30|31)\d{3}[0-9Xx]$/;
                    var tel2 = /^[1-9]\d{5}\d{2}((0[1-9])|(10|11|12))(([0-2][1-9])|10|20|30|31)\d{2}$/;
                    return this.optional(element) || (tel1.test(value)) || (tel2.test(value));
                }, "请正确填写15或18位身份证号码");
            }
        });
    });
</script>
</body>
</html>